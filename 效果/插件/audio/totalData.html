<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>audio-total</title>
</head>
<body>
<canvas width="1800" height="150" id="canvas" style="border:1px solid #000000;background: #8C8D8F"></canvas>
</body>
<script>
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    window.OfflineAudioContext = window.OfflineAudioContext || window.webkitOfflineAudioContext;

    let canvas = document.getElementById("canvas");
    let canvasCtx = canvas.getContext("2d");
    let width = canvas.width;
    let height = canvas.height;
    let audioArr = [], freqData, bufferLength;

    const audioURL = './audio/sunny.mp3';
    const sharedAudioContext = new AudioContext();
    const audioDidLoad = (buffer) => {
        let samplesCount = 0;
        const context = new OfflineAudioContext(2, buffer.length, 44100);
        const source = context.createBufferSource();

        const processor = context.createScriptProcessor(16384, 1, 1);//max-16384

        const analyser = context.createAnalyser();
        analyser.fftSize = 2048;
        analyser.smoothingTimeConstant = 0.25;

        source.buffer = buffer;

        source.connect(analyser);
        analyser.connect(processor);
        processor.connect(context.destination);

        bufferLength = analyser.frequencyBinCount;
        freqData = new Uint8Array(bufferLength);

        processor.onaudioprocess = () => {
            analyser.getByteTimeDomainData(freqData);
            samplesCount++;
            //audio数据的总数组
            audioArr.push(...freqData);
        };
        source.start(0);

        context.startRendering().then(function () {
            console.log('audioArr为', audioArr);
            draw();
        });
        context.oncomplete = () => {
            console.log('samplesCount=', samplesCount);
            source.disconnect(analyser);
            processor.disconnect(context.destination);
        };
    };

    let request = new XMLHttpRequest();
    request.open('GET', audioURL, true);//允许异步
    request.responseType = 'arraybuffer';
    request.onload = () => {
        let audioData = request.response;
        sharedAudioContext.decodeAudioData(
            audioData,
            audioDidLoad,
            e => {
                console.log(e.err)
            }
        );
    };
    request.send();

    function draw() {
        canvasCtx.fillStyle = 'rgb(200, 200, 200)';//填充颜色
        canvasCtx.fillRect(0, 0, 1800, 150);//(x,y,width.height)
        canvasCtx.lineWidth = 2;//线宽
        canvasCtx.strokeStyle = 'rgb(220, 20, 60)';//笔触颜色
        canvasCtx.beginPath();
        let sliceWidth = width * 1.0 / audioArr.length;
        let x = 0;
        for (let i = 0; i < audioArr.length; i++) {
            let v = audioArr[i] / 128.0;
            let y = v * height / 2;
            if (i === 0) {
                canvasCtx.moveTo(x, y);//线起点
            } else {
                canvasCtx.lineTo(x, y);//线终点
            }
            x += sliceWidth;
        }
        canvasCtx.lineTo(width, height / 2);
        canvasCtx.stroke();//实际绘出moveTo和lineTo定义的路径
    }
</script>
</html>
